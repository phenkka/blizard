<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Security Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>üîí Phantom Wallet Security Tests</h1>
    <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è Phantom –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
    
    <div>
        <button onclick="runAllTests()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
        <button onclick="runConnectionTests()">üîó –¢–µ—Å—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
        <button onclick="runSessionTests()">üîê –¢–µ—Å—Ç—ã —Å–µ—Å—Å–∏–π</button>
        <button onclick="runSecurityTests()">üõ°Ô∏è –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</button>
        <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    </div>
    
    <div id="results"></div>
    
    <script src="../config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/base58@2.0.0/lib/base58.min.js"></script>
    <script src="../js/phantom-connect.js"></script>
    
    <script>
        let testResults = [];
        
        function addResult(testName, status, message, details = null) {
            const result = {
                name: testName,
                status: status,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            displayResults();
        }
        
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.status}`;
                
                let content = `<strong>${result.name}</strong>: ${result.message}`;
                if (result.details) {
                    content += `<pre>${JSON.stringify(result.details, null, 2)}</pre>`;
                }
                content += `<small>${new Date(result.timestamp).toLocaleTimeString()}</small>`;
                
                div.innerHTML = content;
                resultsDiv.appendChild(div);
            });
        }
        
        function clearResults() {
            testResults = [];
            displayResults();
        }
        
        async function runAllTests() {
            clearResults();
            await runConnectionTests();
            await runSessionTests();
            await runSecurityTests();
        }
        
        async function runConnectionTests() {
            addResult('Connection Tests', 'info', '–ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
            
            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Phantom
            if (window.solana && window.solana.isPhantom) {
                addResult('Phantom Installation', 'pass', 'Phantom –∫–æ—à–µ–ª–µ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } else {
                addResult('Phantom Installation', 'fail', 'Phantom –∫–æ—à–µ–ª–µ–∫ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                return;
            }
            
            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PhantomConnect
            if (window.PhantomConnect) {
                addResult('PhantomConnect Init', 'pass', 'PhantomConnect –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            } else {
                addResult('PhantomConnect Init', 'fail', 'PhantomConnect –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ API –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    addResult('API Availability', 'pass', 'API –¥–æ—Å—Ç—É–ø–µ–Ω', config);
                } else {
                    addResult('API Availability', 'fail', `API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${response.status}`);
                }
            } catch (error) {
                addResult('API Availability', 'fail', `API –æ—à–∏–±–∫–∞: ${error.message}`);
            }
            
            // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ challenge endpoint
            try {
                const testPublicKey = '11111111111111111111111111111111';
                const response = await fetch('/api/auth/challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ publicKey: testPublicKey })
                });
                
                if (response.ok) {
                    const challenge = await response.json();
                    addResult('Challenge Endpoint', 'pass', 'Challenge endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç', challenge);
                } else {
                    addResult('Challenge Endpoint', 'fail', `Challenge endpoint –æ—à–∏–±–∫–∞: ${response.status}`);
                }
            } catch (error) {
                addResult('Challenge Endpoint', 'fail', `Challenge endpoint –æ—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        async function runSessionTests() {
            addResult('Session Tests', 'info', '–ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–æ–≤ —Å–µ—Å—Å–∏–π...');
            
            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
            const storedWallet = localStorage.getItem('wb_wallet');
            const storedToken = localStorage.getItem('wb_token');
            const storedUser = localStorage.getItem('wb_user');
            
            if (storedWallet && storedToken && storedUser) {
                addResult('Session Storage', 'pass', '–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage');
            } else {
                addResult('Session Storage', 'warning', '–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)');
            }
            
            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
            if (window.PhantomConnect.isLoggedIn()) {
                try {
                    const profile = await window.PhantomConnect.getUserProfile();
                    addResult('Session Validation', 'pass', '–°–µ—Å—Å–∏—è –≤–∞–ª–∏–¥–Ω–∞', profile);
                } catch (error) {
                    addResult('Session Validation', 'fail', `–°–µ—Å—Å–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞: ${error.message}`);
                }
            } else {
                addResult('Session Validation', 'warning', '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏');
            }
            
            // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–µ—Å—Å–∏–∏
            const originalWallet = localStorage.getItem('wb_wallet');
            window.PhantomConnect.clearSession();
            const clearedWallet = localStorage.getItem('wb_wallet');
            
            if (!clearedWallet && originalWallet) {
                addResult('Session Cleanup', 'pass', '–°–µ—Å—Å–∏—è –æ—á–∏—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
                localStorage.setItem('wb_wallet', originalWallet);
            } else if (!originalWallet) {
                addResult('Session Cleanup', 'warning', '–ù–µ—Ç —Å–µ—Å—Å–∏–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏');
            } else {
                addResult('Session Cleanup', 'fail', '–°–µ—Å—Å–∏—è –Ω–µ –æ—á–∏—Å—Ç–∏–ª–∞—Å—å');
            }
            
            // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ localStorage
            try {
                const testData = 'test_data';
                localStorage.setItem('wb_test', testData);
                const retrieved = localStorage.getItem('wb_test');
                localStorage.removeItem('wb_test');
                
                if (retrieved === testData) {
                    addResult('LocalStorage Security', 'pass', 'LocalStorage —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                } else {
                    addResult('LocalStorage Security', 'fail', 'LocalStorage –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                }
            } catch (error) {
                addResult('LocalStorage Security', 'fail', `LocalStorage –æ—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        async function runSecurityTests() {
            addResult('Security Tests', 'info', '–ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...');
            
            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
            if (window.location.protocol === 'https:') {
                addResult('HTTPS Check', 'pass', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ HTTPS');
            } else if (window.location.hostname === 'localhost') {
                addResult('HTTPS Check', 'warning', 'HTTP –Ω–∞ localhost (–¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)');
            } else {
                addResult('HTTPS Check', 'fail', '–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
            }
            
            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ CSP (Content Security Policy)
            const metaCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (metaCSP) {
                addResult('CSP Header', 'pass', 'CSP –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞–π–¥–µ–Ω');
            } else {
                addResult('CSP Header', 'warning', 'CSP –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ URL
            const url = window.location.href;
            const sensitivePatterns = ['token=', 'password=', 'secret=', 'key='];
            const hasSensitiveInUrl = sensitivePatterns.some(pattern => url.includes(pattern));
            
            if (!hasSensitiveInUrl) {
                addResult('URL Security', 'pass', '–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤ URL');
            } else {
                addResult('URL Security', 'fail', '–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã –≤ URL');
            }
            
            // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–æ–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
            if (window.WORLDBINDER_CONFIG && window.WORLDBINDER_CONFIG.DEBUG_MODE === false) {
                addResult('Debug Logs', 'pass', '–û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ');
            } else if (window.WORLDBINDER_CONFIG && window.WORLDBINDER_CONFIG.DEBUG_MODE === true) {
                addResult('Debug Logs', 'warning', '–û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏ –≤–∫–ª—é—á–µ–Ω—ã (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)');
            } else {
                addResult('Debug Logs', 'warning', '–°—Ç–∞—Ç—É—Å –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö –ª–æ–≥–æ–≤ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω');
            }
            
            // –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ base58
            try {
                const testBytes = new Uint8Array([1, 2, 3, 4, 5]);
                const encoded = base58.encode(testBytes);
                const decoded = base58.decode(encoded);
                
                if (arraysEqual(testBytes, decoded)) {
                    addResult('Base58 Security', 'pass', 'Base58 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    addResult('Base58 Security', 'fail', 'Base58 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                }
            } catch (error) {
                addResult('Base58 Security', 'fail', 'Base58 –æ—à–∏–±–∫–∞: ' + error.message);
            }
            
            // –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç XSS
            const xssTestString = '<script>alert(xss)</script>';
            const div = document.createElement('div');
            div.textContent = xssTestString;
            
            if (div.textContent === xssTestString && !div.innerHTML.includes('<script>')) {
                addResult('XSS Protection', 'pass', '–ó–∞—â–∏—Ç–∞ –æ—Ç XSS —Ä–∞–±–æ—Ç–∞–µ—Ç');
            } else {
                addResult('XSS Protection', 'fail', '–£—è–∑–≤–∏–º–æ—Å—Ç—å –∫ XSS');
            }
            
            // –¢–µ—Å—Ç 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–æ–≤
            const storedToken = localStorage.getItem('wb_token');
            if (storedToken) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ JWT
                const parts = storedToken.split('.');
                if (parts.length === 3) {
                    try {
                        const header = JSON.parse(atob(parts[0]));
                        const payload = JSON.parse(atob(parts[1]));
                        
                        if (header.alg && payload.exp) {
                            addResult('Token Format', 'pass', 'JWT —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞');
                        } else {
                            addResult('Token Format', 'warning', 'JWT —Ç–æ–∫–µ–Ω –Ω–µ–ø–æ–ª–Ω—ã–π');
                        }
                    } catch (error) {
                        addResult('Token Format', 'fail', 'JWT —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞');
                    }
                } else {
                    addResult('Token Format', 'fail', '–¢–æ–∫–µ–Ω –Ω–µ –≤ JWT —Ñ–æ—Ä–º–∞—Ç–µ');
                }
            } else {
                addResult('Token Format', 'warning', '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
            }
            
            // –¢–µ—Å—Ç 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤
            try {
                const response = await fetch('/api/config');
                const headers = response.headers;
                
                const securityHeaders = [
                    'x-content-type-options',
                    'x-frame-options',
                    'x-xss-protection'
                ];
                
                const foundHeaders = securityHeaders.filter(header => 
                    headers.get(header)
                );
                
                if (foundHeaders.length > 0) {
                    addResult('Security Headers', 'pass', '–ù–∞–π–¥–µ–Ω—ã security headers: ' + foundHeaders.join(', '));
                } else {
                    addResult('Security Headers', 'warning', 'Security headers –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
            } catch (error) {
                addResult('Security Headers', 'fail', '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ security headers: ' + error.message);
            }
        }
        
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            addResult('Test Suite', 'info', '–¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞.');
        });
    </script>
</body>
</html>
